---
title: "Climate-driven elevational range dynamics of dominant trees in the Western Himalayas"

author:
  - name: Abhishek Kumar
    url: https://akumar.netlify.app/
    orcid: 0000-0003-2252-7623
    email: abhikumar.pu@gmail.com
    affiliation: Panjab University, Chandigarh
    
  - name: Meenu Patil
    url: https://www.researchgate.net/profile/Meenu-Patil
    orcid: 0000-0002-7664-7877
    email: patilmeenu2@gmail.com
    affiliation: Panjab University, Chandigarh
    
  - name: Pardeep Kumar
    url: https://www.researchgate.net/profile/Pardeep-Kumar-22
    orcid: 0000-0001-6707-1485
    email: pardeepmor989@gmail.com
    affiliation: Panjab University, Chandigarh
    
  - name: Anand Narain Singh
    url: https://www.researchgate.net/profile/Anand-Singh-15
    orcid: 0000-0002-0148-8680
    email: dranand1212@gmail.com
    affiliation: Panjab University, Chandigarh

bibliography: refs.bib
csl: ecological-applications.csl

format: 
  # html:
  #   number-sections: true
  #   toc: true
  #   toc-depth: 3
  #   default-image-extension: png
  
  pdf:
    documentclass: scrartcl
    papersize: letter
    number-sections: true
    mainfont: Arial
    fontsize: 10pt
    linestretch: 1.5
    sansfont: Arial
    colorlinks: true
    link-citations: true
    citecolor: "#0000ff"
    default-image-extension: pdf
    code-block-bg: true
  
  docx:
    reference-doc: ecol-app.docx
    link-citations: true
    link-bibliography: true
    fig-dpi: 600
    default-image-extension: png
    
crossref: 
  title-delim: "  "
  fig-title:  "FIGURE"  ## caption title
  fig-prefix: "Figure"  ## inline title
  tbl-title:  "TABLE"
  tbl-prefix: "Table"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  comment = "#>", echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE
)

## load packages
library(biomod2)        ## species distribution modeling
library(emmeans)        ## estimate marginal means
library(sf)             ## vector data handling
library(terra)          ## raster data handling
library(tidyverse)      ## general data manipulation and visualisation
library(tmap)           ## visualising spatial data

## colour palette for study sites
scen_pal <- c("current" = "#440154ff", "2040" = "#31688eff", 
              "2070" = "#35b779ff", "2100" = "#fde725ff")

## set theme for ggplot
theme_set(
  theme_bw(base_size = 14) +
    
    theme(
      panel.grid = element_blank(),
      
      axis.text = element_text(size = 10),
      
      strip.background = element_blank(),
      strip.text = element_text(hjust = 0, face = "bold")
    )
)
```

**Affiliation:** Soil Ecosystem and Restoration Ecology Lab, Department of Botany, Panjab University, Chandigarh 160014, INDIA

**Correspondence:** Anand Narain Singh. Email: <dranand1212@gmail.com>; <ansingh@pu.ac.in> 

**Contact author:** Abhishek Kumar. Email: <abhikumar.pu@gmail.com>

**Co-first authors:** Abhishek Kumar and Meenu Patil are equal contributors to this work and designated as co-first authors.

**Open Research Statement:** Data and `R` codes are provided as private-for-peer review via the following link: <https://github.com/kumar-a/shifting-distributions>. Upon acceptance data will be archived in FigShare or Zenodo.


\newpage
# Abstract {.unnumbered}

Understanding species redistributions in response to climate change is crucial for prioritizing conservation efforts and developing effective biodiversity management plans. Since responses to climate change can be highly variable and species-specific, this study investigated the elevational range dynamics of ten dominant tree species in the Western Himalayas. Considering the lack of historical data, we used ensemble MaxEnt modeling to predict the habitat suitability for current (2010) and future climatic scenarios (2040, 2070, and 2100). Our results indicated range contractions for *Cedrus deodara*, *Pinus roxburghii*, *Quercus lanata*, *Quercus semecarpifolia*, and *Rhododendron arboreum*; and an upward shift in distribution of *Lyonia ovalifolia*, *Mallotus philippensis*, and *Quercus leucotrichophora*. The elevation range of *Shorea robusta* and *Taxus wallichiana* can lean towards higher and lower elevations, respectively. Further, we observed a net decline in suitable habitats for investigated tree species, except *Shorea robusta*, with the highest decline observed for *Quercus semecarpifolia* followed by *Taxus wallichiana*. The observed range dynamics and habitat suitability decline raise concerns for future ecosystem stability and biodiversity conservation in the region. Our study will contribute to developing targeted management strategies to ensure the resilience of these dominant trees.

**Keywords:** climate change, dominant trees, elevational gradients, habitat suitability, MaxEnt modeling, range dynamics, species distribution, Western Himalayas

# Introduction

Among the identified major threats to biodiversity [@Jaureguiberry2022; @WWF2020], climate change is emerging as a serious risk to biodiversity because it can drive an irreversible decline in biodiversity at larger spatial scales [@WWF2020]. There is a growing consensus that global warming is real and caused mainly by human-mediated activities [@IPCC2023]. The earth's average surface temperature has already risen 1.1&deg;C above the pre-industrial (1850--1900) levels from 2011 to 2020 [@IPCC2023]. Consistent with global observations, the annual mean temperature in India increased with an average rate of 0.15&deg;C per decade during 1986--2015 [@Krishnan2020]. The Hindu Kush Himalayas (HKH) exhibited an average increase of 0.2&deg;C per decade in annual mean surface (air) temperature from 1951 to 2014 [@Krishnan2020]. The rate of warming is positively associated with elevation, and higher elevation regions such as Ladakh indicate an average increase of 0.5&deg;C per decade [@Wester2019]. If warming continues at this rate, the next century is projected to be even hotter, and the earth's surface will become 1.5&deg;C more hotter than pre-industrial levels on average during the next century [@IPCC2023]. Since climate directly influences the distribution of living organisms [@Currie2004], it is imperative to understand the biodiversity dynamics under future climatic scenarios to manage biodiversity effectively [@Bonebrake2018].

Available literature indicates that many taxonomic groups have shifted their distribution towards higher latitudes and elevations in response to climate warming [@Lenoir2015; @Parmesan2003]. Some global syntheses suggest that species are shifting their distribution at an average rate of 6--17 km per decade northwards and 6--29 m per decade upwards across different taxa [@Chen2011; @Lenoir2008; @Parmesan2003]. However, different ecosystems and taxa showed high variation in the magnitude and direction of changes in species distribution [@Lenoir2015; @Lenoir2020]. The species range shifts were higher for taxa in marine ecosystems than the terrestrial ecosystems [@Lenoir2020]. Similarly, the short-lived and non-native taxa displayed higher shifts in distribution than long-lived and native taxa among the terrestrial ecosystems [@Lenoir2015]. In mountain ecosystems, the species range shifts also vary with elevation apart from species identity [@Mamantov2021; @OSullivan2020; @Rumpf2018]. This variation in distributional shifts suggests that our understanding of climate-related species redistribution remained limited despite recent research efforts [@Lenoir2015]. While available studies provide evidence for shifting distributions, these range shifts are neither synchronous nor homogeneous across taxa [@Chen2011; @Lenoir2020]. Further, limited information is available about the distribution dynamics for many taxa across different geographical regions [@Lenoir2015]. Therefore, we need further investigations on climate-related distributional shifts for understudied taxa in under-represented geographical regions to effectively manage the biodiversity under ongoing environmental change.

The geographic area occupied by all individuals of a species at a given time is referred to as the *distribution range* of a species [@Lenoir2013]. Assuming an unimodal distribution of individuals within the species' range (@fig-species-range), the area with maximum species abundance is referred to as the 'optimum range' whereas the peripheral area with minimum abundance is called 'range edge' or 'range margin' [@Lenoir2013]. Along the single dimension of elevation, the range edge towards the lower elevation limit can be referred to as the 'trailing edge' whereas that towards the upper elevation limit can be called the 'leading edge' [@Lenoir2013]. The species distribution dynamics are often quantified in terms of these three range parameters (trailing edge, optimum range, and leading edge) of species geographic range [@Rumpf2018; @Rumpf2019; @Wiens2016]. Based on the changes in range parameters, the species range can 'march', 'contract/expand', or 'lean' under future climate scenarios [@Breshears2008; @Lenoir2015]. In response to climate change, the trailing and leading edges can move in the same direction (marching or range shifting) or opposite direction (range contraction/expansion). Further, the 'range leaning' can emerge when either range edges (trailing or leading edge) or optimum range show considerable changes but at least one of these range parameters remains unchanged or show little changes. However, available literature indicates high idiosyncrasies in climate-related changes in these range parameters [@Lenoir2013; @Lenoir2015]. Since these responses can be highly species-specific, we need to assess the range dynamics for different taxa and identify the most vulnerable species to set priorities for species conservation programs. For example, some species, like oaks, may be unable to move upwards and survive due to the climatic requirements of the phenology and seed formation [@Bisht2013]. Therefore, there is a clear need to investigate climate-induced range dynamics to conserve species facing the threat of extinction from range shifting or range contractions.

```{r fig.width=7, fig.height=4}
#| label: fig-species-range
#| fig-cap: A hypothetical model for elevational species range showing the optimum range (grey colored), trailing edge (brown colored), and leading edge (blue colored). Lighter colors represent the elevational zones with a higher number of individuals.

df_label <- data.frame(x = c(-2.7, 0, 2.7), 
                       y = c(0.05, 0.3, 0.05),
                       label = c("Trailing edge", "Optimum range", "Leading edge"))

data.frame(x = seq(-3, 3, 0.01), y = dnorm(seq(-3, 3, 0.01))) |>
  mutate(qt = cut(x, breaks = 10, labels = FALSE)) |>
  ggplot(aes(x, y)) +
  geom_area(aes(group = qt, fill = qt)) +
  geom_text(data = df_label, aes(x = x, y = y, label = label),
            size = 4.5) +
  scale_fill_gradient2(midpoint = 5.5) +
  labs(x = "Elevation", y = "Abundance") +
  theme_bw(base_size = 14) +
  theme(panel.grid = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(), legend.position = "none")

# ggsave(filename = "figs/01-species_range.pdf", height = 4, width = 8)
# ggsave(filename = "figs/01-species_range.png", height = 4, width = 8, dpi = 600)
```

Despite growing efforts to study the climate-related changes in species distributions, our understanding remained limited [@Bonebrake2018]. Studies investigating species redistributions are poorly represented in Asian countries like India [@Lenoir2015; @Rawat2010]. The lack of information about geographical species distributions and historical records is a major challenge in investigating the species range shifts in response to climate change [@Lenoir2015; @Rawat2010]. Thus, resurvey studies are not possible due to a lack of historical data, and many plants show lagged responses or move slowly in response to climate warming. Considering these limitations, species distribution modeling emerges as a powerful technique to investigate the climate-driven shifting of plant distributions in under-studied regions like the Indian Himalayas [@Guisan2017; @Maharjan2023; @Phillips2006]. Further, high idiosyncrasies in species responses indicate the need to consider multiple species while studying the species range shifts in response to climate change [@Lenoir2015]. Therefore, we aim to assess the impact of climate change on the elevational distribution of dominant tree species in the Western Himalayas. Specifically, we aim to (1) analyze the change in habitat suitability over space and time, (2) investigate the elevational range dynamics, (3) analyze the elevational change in species richness, and (4) assess the importance of environmental variables in predicting habitat suitability. Considering the uncertain and variable effects of climate change on species distributions [@Bonebrake2018], our study will contribute to identifying the tree species that are most vulnerable to climate change and understanding the projected dynamics of elevational range for dominant tree species in the Western Himalayas. Additionally, this study will improve our understanding of the specific environmental variables regulating the distribution dynamics of dominant trees in the Western Himalayas.

# Methodology

## Study area

The Western Himalayas refer to the mountain range in north-western India that stretches from the Indus River in the west to the Kali River in the east. Geographically, it spreads over the entire Jammu & Kashmir (union territory), Himachal Pradesh and Uttarakhand states of India. The elevation in the Western Himalayas ranges from 300 meters to over 5,000 meters above mean sea level (@fig-site-map). The vegetation types range from mixed deciduous forests to alpine grasslands and support a rich diversity of plants, animals, and other living organisms. 

```{r}
# ## make site map
# source("R/1-make_site_map.R")
```

![Map showing the geographic locations of species occurrence in Western Himalaya spanning Himachal Pradesh and Uttarakhand states of India. The inset map shows the location of the Western Himalayas in the Hindu Kush Himalayas.](figs/02-site_map.png){#fig-site-map}

The climate in the Western Himalayas depicts substantial variation and varies from dry tropical to polar climates [@Beck2018]. The western part receives winter snow influenced by Mediterranean climates, whereas the eastern part receives summer rain influenced by the Indian Monsoon. However, the Western Himalayas are experiencing notable changes in weather patterns and elevation-dependent warming [@Krishnan2020]. The Western Himalayas provide a good opportunity to study elevational shifts in plant distributions due to its large elevational gradients, rich plant diversity, and substantial changes in climatic environments.

## Species occurrence

In our previous study, we prepared a checklist of plant species (n = 1385) reported from three protected areas in the Western Himalayas [@Kumar2023a]. We retrieved the occurrence data for all species (n = 1012) that matched with taxonomic names in the Global Biodiversity Information Facility ([GBIF](https://www.gbif.org/)) database on 21 September 2023 [@GBIF2023]. These occurrence records were based on (1) preserved specimens, human observation, observation, and machine observation; (2) found in India; (3) found within the bounding box of the Western Himalayas; (4) spatial coordinates; (5) has no GBIF geospatial issues; (6) occurrence status is presence only; and (7) observation is recorded in or after the 1980 year. These species occurrences were downloaded using the `rgbif` package version `r packageVersion("rgbif")` [@R-rgbif] in `R` statistical environment version `r packageVersion("stats")` [@R-base]. Additionally, we compiled species occurrences from published literature (Appendix S1: Table S1), and field surveys using a GPS receiver (Garmin eTrex 10) from the Morni Hills, Chail WLS, and Churdhar WLS in the Western Himalayas.

```{r}
# ## get GBIF species occurrences
# source("R/2-get_gbif_occ.R")
```

To investigate the climate-driven elevational range shifts, we initially selected 15 tree species that (1) dominate the local forest type [@Champion1968] or ecologically important; (2) had spatially balanced distribution across the Western Himalayas; (3) had sufficient number (n > 40) of raw occurrence distribution; (4) are not under cultivation or domestication, and (5) are relatively less affected by land-use change and human activities. Similar criteria have been previously used to select the plant species to investigate the shifting plant distributions [@Liang2018]. We compiled a database of geographical occurrences for selected species by combining data from the [GBIF](https://www.gbif.org/), published literature (Appendix S1: Table S1) and field survey. Next, we screened each recorded geographic occurrence for its quality and plausibility (Appendix S1: Figure S1). Specifically, we retained only those occurrence records that (1) were inside our study area, (2) corresponded to a tree cover of more than 50% at ~30 arc-sec resolution [@Zanaga2021], and (3) were within the observed elevational range of the species. Filtering records based on tree cover allowed us to minimize the effects of land use and human activities. Further, we randomly selected only one record within the defined cell size of 0.2 degrees (~22.22 km) to minimize sampling bias and spatial dependence. Finally, we selected species (n = 10) with at least 20 cleaned species occurrences (@tbl-selected-species).

```{r}
# ## clean species occurrences
# source("R/3-clean_species_occ.R")
```

```{r}
#| label: tbl-selected-species
#| tbl-cap: Summary of cleaned geographical occurrences (n) used for modeling tree species distributions in the Western Himalayas. The observed lower elevational limit (LL) and upper elevational limit (UL) used for cleaning are also presented. The elevational limits are represented in metre units.

selected_species <- read.csv("data/selected_species.csv")

read.csv("output/cleaned_occ.csv") |>
  count(species) |>
  left_join(
    selected_species, by = join_by("species" == "taxon_name")
  ) |>
  mutate(Species = paste0("*", species, "* ", taxon_authors)) |>
  select(Species, family, LL, UL, n) |>
  rename("Family" = family) |>
  knitr::kable()
```

## Environmental variables

We were unaware of specific environmental variables that determine the distribution of selected species. Therefore, we used a set of 19 bioclimatic variables that have been frequently included to model the species distribution [@Bobrowski2021; @Guisan2017]. These variables have been supposed to be more biologically meaningful than the monthly climate variables. We downloaded these climatic variables at 30-arc-sec (~1 km) resolution for 1981--2010 (hereafter 'current') from the CHELSA (<https://chelsa-climate.org/>) database version 2.1 [@Karger2017]. This database has been considered appropriate for ecological modeling in complex ecosystems like the Himalayas [@Bobrowski2021]. We did not include elevation, slope, and aspect because we infer they are only indirectly related to species' distribution and physiology [@Korner2007]. Additionally, our previous study indicated that topographic heterogeneity is less important than the climate [@Kumar2023b]. Further, topographic variables like elevation, slope, and aspect have been suggested to be poor predictors of species distributions as compared to climatic variables like temperature and precipitation [@Bradie2017].

Next, we calculated the variance inflation factor (VIF) for all the 19 bioclimatic variables using the `vifstep()` function from the `usdm` package version `r packageVersion("usdm")` [@R-usdm]. Variables with a VIF greater than ten were considered correlated [@Guisan2017] and excluded from further analysis to minimize the bias due to multicollinearity among predictors [@Dormann2013]. This VIF-based variable selection identified six bioclimatic variables: mean diurnal air temperature range (bio2), isothermality (bio3), mean daily mean air temperatures of the wettest quarter (bio8), precipitation amount of the driest month (bio14), precipitation seasonality (bio15) and mean monthly precipitation amount of the warmest quarter (bio18). These bioclimatic variables showed substantial variation over the study region (Appendix S1: Figure S3).

```{r fig.height=8, fig.width=8}
# ## variance inflation factor (VIF)
# rast("data/wh_bio_2010_current.tif") |>
#   usdm::vifstep(th = 10)
# 
# ## pairwise correlation
# rast("data/wh_bio_2010_current.tif") |>
#   subset(c(2, 3, 8, 14, 15, 18)) |> ## all have r < 0.8
#   terra::pairs(maxcells = 1e3)
```

The sixth phase of the Coupled Model Intercomparison Project [CMIP6, @Eyring2016] uses five future scenarios with expected socioeconomic changes up to 2100, which are referred to as the Shared Socioeconomic Pathways [SSPs, @ONeill2014]. These pathways are used to generate scenarios for greenhouse gas (GHG) emissions under various climate policies [@IPCC2023]. Among these five scenarios, the SSP5--8.5 and SSP3--7.0 scenarios were considered unlikely [@Hausfather2020]. The SSP1--2.6 expects global warming of 1.8&deg;C during 2081--2100 under a low GHG emissions scenario with CO~2~ emissions cut to net zero around 2075. To project the species distribution under future climatic conditions, we used the likely climatic conditions under the SSP1--2.6 scenarios from the GFDL-ESM4 model [@Zhao2018]. We downloaded the selected five bioclimatic variables for 2011--2040 (hereafter 2040), 2041--2070 (hereafter 2070), and 2071--2100 (hereafter 2100) under SSP1--2.6 from CHELSA database version 2.1 [@Karger2017]. 

## Distribution modeling

Our dataset consisted of locations for species presence and lacked information about species absence (presence-only data). The MaxEnt is considered one of the most popular [@Hao2019] and best-performing algorithms for such data lacking information about true species absences [@Valavi2022]. This algorithm is considered to cope well with a small number of species presence records and is computationally fast [@Gogol-Prokurat2011; @Thibaud2014; @Valavi2022]. It finds the solution by minimizing the relative entropy between the probability densities of presence (*f~1~*) and background points (*f*) defined in environmental (covariate) space [@Elith2011]. Thus, it contrasts the observed presence points to the available environment in a region (background). The background points are locations in the study area (including both presence and absence) representing the entire available environmental space [@Merow2013]. 

MaxEnt needs a sufficiently large number of background points to represent the full gradient of environment space for optimal performances [@Elith2011; @Merow2013; @Phillips2009]. To determine the number of background points and sampling method, the performance of MaxEnt models was compared using the 250, 500, 1000, 2000, and 5000 background points generated by disk (1 km to 50 km) and random sampling for *Mallotus philippensis* as a test case (Appendix S1: Figure S4). It was revealed that the model performance was better for more than 1,000 randomly sampled background points. Therefore, this study used 1,000 randomly sampled locations from the full extent of the study area as background points. Random sampling is commonly used to select pseudo-absence or background points [@Hao2019], though it is ecologically unrealistic and may introduce sampling bias. Since MaxEnt models the density of used environmental conditions rather than species presence [@Elith2011], the random sampling of background points would have little effect on model performance [@Phillips2008]. Since random sampling is a stochastic procedure, we generated three sets (PA1, PA2, and PA3) of 1,000 random background points to minimize the sampling bias [@Guisan2017; @Valavi2022].

```{r}
## run initial analysis to decide background points
# source("R/4-decide_background.R")
```

Although MaxEnt models with default settings (un-tuned) may lead to suboptimal model performances [@Merow2013; @Warren2011], these un-tuned models are frequently used to model species distributions [@Hao2019]. The default settings of MaxEnt were chosen based on the model performance for different taxonomic groups [@Phillips2008]. MaxEnt uses six model parameters (features): linear, product, quadratic, hinge, threshold, and categorical features to optimize the models [@Elith2011]. All six features will be used if the number of presences is greater than 80 under the default settings [@Merow2013; @Phillips2008]. Further, MaxEnt uses regularization to avoid over-tuning while fitting a fairly complex response variable. Thus, it fits a penalized maximum likelihood model that aims to trade off model fit and model complexity [@Phillips2008]. We used the un-tuned MaxEnt models because we aimed to model multiple species simultaneously, and it is impractical to build species-specific tuned models [@Merow2013]. Since the raw output of MaxEnt represents the relative suitability of the environment (*f~1~/f*), it is back-transformed into logistic outputs [@Elith2011; @Phillips2006]. The MaxEnt models were implemented in the `R` statistical environment using the `biomod2` package version `r packageVersion("biomod2")` [@R-biomod2; @Thuiller2009] together with the standalone java-based MaxEnt software version 3.4.3 [@Phillips2006]. 

## Model evaluation

We followed the frequently used split-sample cross-validation approach to evaluate the model performance because an independent external dataset was not available [@Hao2019]. This approach randomly splits the initial dataset into two subsets, i.e., one for training the model and the other for testing the model. We calibrated our models with 70% of the data (training set) and evaluated with the remaining 30% (validation set). This procedure was repeated four times (RUN1, RUN2, RUN3, and RUN4) to minimize the bias due to random splitting of the initial dataset. Thus, we build 12 individual models (3 pseudo-absence sets &times; 4 cross-validation runs) for each species. 

The predictive accuracy of models was evaluated using the true skill statistic (TSS) and the area under the receiver operating characteristic curve (AUC~ROC~) [@Guisan2017]. Both these metrics measure the model's discrimination ability to distinguish between species presence and absence (in our case, suitable and unsuitable). The probabilities of species presence are first converted into binary observations of species presence and absence using a threshold value. An incorrectly predicted absence (false absence) is known as an *omission* error, whereas an incorrectly predicted presence (false presence) is known as a *commission* error. The percentage of correctly predicted presences (true presence) is known as *sensitivity*, whereas the percentage of correctly predicted absences (true absence) is known as *specificity*. The TSS is defined as the sum of sensitivity and specificity minus one. Thus, TSS is a threshold-dependent metric because its value depends on the threshold value choice. The threshold value maximizing the TSS was considered the optimum threshold for converting probabilities into binary species presence and absence [@Liu2013]. Therefore, models with higher predictive accuracy will have values close to one, and TSS scores greater than 0.7 are considered useful to excellent [@Allouche2006]. 

On the other hand, the AUC~ROC~ is a threshold-independent discrimination metric because it integrates all evaluation values at all thresholds into a single final metric using the graphical approach. The ROC curve is constructed by plotting the sensitivity (percentage of correctly predicted presences) against the commission error rates (percentage of wrongly predicted absences), and then the area under this curve is calculated as the final metric. The AUC~ROC~ values greater than 0.7 are considered fair to excellent [@Araujo2005]. However, the AUC~ROC~ is sensitive to prevalence, whereas the TSS is unaffected by prevalence [@Allouche2006].

## Ensemble modeling

Ensemble models can improve transferability across space and time by accommodating variability among individual models [@Hao2020]. Therefore, we build ensemble models for each species to summarise the performances of their 12 individual models. We used two popular methods for building ensemble models: committee averaging (EMca) and weighted mean (EMwmean) [@Hao2019]. The EMca approach first transforms the probabilities from selected models into the binary species presence (1) and absence (0) based on a threshold defined by maximizing the evaluation metric score on a testing dataset. Then, it takes the average of binary predictions from all selected models. Thus, the committee averaging score of 0 or 1 means all models agree, whereas any values between 0 and 1 indicate at least one model disagrees with predictions. On the other hand, the EMwmeans approach weights the probabilities from each model based on the evaluation score and then sums all the probabilities. The individual model with better performance receives higher weight and, therefore, has higher importance in the ensemble. Since the performance of the ensemble model depends on the quality of individual models, we used a threshold TSS score of 0.7 to remove low-quality models (TSS < 0.7), perform binary transformation for EMca (presence = TSS > 0.7 and absence = TSS < 0.7) and define model weights for EMwmean [@Nikkel2023]. The performance of ensemble models was also evaluated using the same evaluation metrics (TSS and AUC~ROC~) as used for individual models. To ensure reproducibility and transparency, we adopted the standard ODMAP protocol [@Zurell2020] to report the details of the modeling workflow used in this study (Appendix S1: Section S3).

```{r}
## model habitat suitability for each species (may take 5-6 hours)
# source("R/5-model_spec_dist.R")
```


## Data analysis

This study aimed to analyze the predicted changes in habitat suitability over space and time for dominant trees of the Western Himalayas. We used the best ensemble model (out of EMca and EMwmean) to project the model predictions to near-current environmental conditions (2010) and future environmental conditions for 2040, 2070, and 2100 under the SSP1--2.6 scenario. The predicted habitat suitability (scaled to 0--1000 in output) was converted into binary map projections using the threshold that maximizes TSS evaluation scores [@Liu2013; @Thuiller2019]. Then, we estimated the species range change by calculating the number of pixels gaining or losing habitat suitability under future climatic conditions compared to current ones. The species range change was computed using the `BIOMOD_RangeSize()` function from the `biomod2` package [@R-biomod2]. 

Another aim of this study was to assess the assemblage level change in habitat suitability under future climatic scenarios. We calculated the predicted species richness for each climatic scenario (represented by years) by stacking the binary map projections for each species (n = 10). To evaluate the predicted changes in species richness, we subtracted the predicted species richness for current climates (2010) from the predicted species richness for different climatic scenarios (2040, 2070, and 2100). Then, we calculated the percentage of pixels predicted to undergo changes in species richness for future climatic conditions. Further, we extracted the elevation for each pixel, representing the change in species richness, using the `extract()` function from the `terra` package version `r packageVersion("terra")` [@R-terra]. Then, we used the boxplot to explore the relationship between elevation and change in species richness.

```{r}
## get assemblage level suitability
# source("R/6-get_spec_rich.R")
```

Our primary aim was to investigate the potential elevational shifts in plant distributions due to projected climate change. We extracted the elevation values for each pixel where our ensemble model predicted a suitable habitat for species presence. Then, we plotted the pixel density against the elevation for each species under current and future climatic conditions to assess the predicted shifts in elevational ranges visually. To estimate the pixel density, we used Silverman's rule-of-thumb to choose the bandwidth of a Gaussian kernel density estimator [@Silverman1986]. Further, we used three parameters of the species' elevational range (trailing edge, range optimum, and leading edge) to analyze species' range dynamics [@Lenoir2015]. The optimum elevation was defined as the 100-m elevational band with the maximum number of pixels where the model predicted species presence. Using a conservative approach, we defined the trailing edge (lower limit) and leading edge (upper limit) as the 5th and 95th percentile of elevations of all predicted suitable pixels [@Maharjan2023]. 

To test the effect of climatic scenarios (current, 2040, 2070 and 2100) on elevational range parameters, we used type-II analysis of variance (ANOVA) because the data for range parameters was unbalanced. Since the number of pixels with suitable habitat can vary with climatic conditions, we computed the least-square means or the estimated marginal means (EMMs) of the range parameters using the general linear model. Then, these EMMs were compared for current and future climatic conditions in a pairwise fashion with Tukey's  adjustment for multiple comparisons (equivalent to Tukey's test). The pairwise comparison was implemented using the `emmean` package version `r packageVersion("emmeans")` [@R-emmeans]. Further, we regressed the EMMs of range parameters against the year of climatic conditions (2010, 2040, 2070, and 2100) and estimated the slope values using a general linear model. These estimated slope values were compared to analyze the potential range dynamics of species elevation ranges under projected climate change scenarios.

```{r}
## model habitat suitability for each species
# source("R/7-get_suit_elev.R")
```

One of the objectives of this study was to investigate how different environmental variables influence the presence of species. To estimate the importance of environmental variables, each environmental variable was shuffled, and model predictions were computed using the shuffled variable. Pearson's correlation coefficient (*r*) was calculated between the reference and shuffled variable predictions. The final variable importance score is calculated by subtracting Pearson's correlation from one (1 -- *r*). A high correlation between reference and shuffled predictions will indicate little or no influence on the model, and therefore, the variable importance score will have a lower value. A zero value assumes that the variable does not influence the model. On the other hand, higher scores will indicate a low correlation between reference and shuffled predictions; therefore, the higher the importance of the variable. Since variable shuffling is a stochastic procedure, we used three permutations (n = 3) for each environmental variable to estimate its importance score [@R-biomod2; @Thuiller2009]. 

Further, we used the evaluation strip procedure to analyze how each environmental variable influences the probability of species' presence or habitat suitability [@Elith2005]. A plot of the predicted response variable (probability of presence) on the y-axis and one or more predictor variables on the x-axis is usually called the *response curve*. We build these plots by generating predictions from each model on a dataset where only one variable can vary, and all others (n -- 1) were kept constant to their mean. The response curves from evaluated all models (12 individual and two ensemble models) were summarized using the generalized additive model (GAM) with a shrinkage version of penalized cubic spline defined by a modest-sized set of knots spread evenly through the covariate values. The smoothing parameter was estimated restricted maximum likelihood (REML) method. All statistical analyses were implemented in `R` statistical environment version `r packageVersion("stats")` [@R-base], and package `tidyverse` version `r packageVersion("tidyverse")` was used for general data wrangling and visualization [@R-tidyverse]. Further details on specific computational platforms and other `R` packages used in this study are provided as Session Info (Appendix S1: Section S4).

# Results

Our initial dataset comprised a total of 1876 geographic occurrences in the Western Himalayas for 15 chosen species from GBIF (n = 412), published literature (n = 1325), and field surveys (n = 139). The cleaning of species occurrences revealed that out of the initial 1876 occurrences, 114 were outside our study area, 305 were outside forests (<50% tree cover), 233 were outside the known species' elevational range, and 845 were duplicated within 0.2-degree cells (Appendix S1: Figure S1). After cleaning and preprocessing the occurrences, our final dataset comprised 308 cleaned occurrences for ten tree species with at least 20 occurrences within our study area (Appendix S1: Figure S2).

```{r fig.width=7, fig.height=6}
#| label: fig-eval-score
#| fig-cap: (a) Comparison of model evaluation scores (AUC~ROC~ and TSS) for the Calibration and Validation dataset. The values represent the mean &pm; SD of individual models (n &equals; 12) for each selected tree species. (b) Comparison of model evaluation scores (AUC~ROC~ and TSS) for the committee averaging (EMca) and weighted mean averaging (EMwmean) algorithm for ensemble modeling. Individual models with a TSS value greater than 0.7 were included in the ensemble.

## evaluation score of individual models
p1 <- list.files(
  path = "output/mod_eval",
  pattern = "single_eval_scores",
  full.names = TRUE
) |>
  read_csv() |>
  separate(col = full.name, into = "species", sep = "_", 
           remove = TRUE, extra = "drop") |>
  pivot_longer(cols = c("calibration", "validation"), 
               names_to = "dataset", values_to = "x") |>
  select(species, metric.eval, dataset, x) |>
  mutate(dataset = str_to_title(dataset)) |>
  group_by(species, metric.eval, dataset) |>
  summarise(xmean = mean(x), xsd = sd(x)) |>
  mutate(species = gsub("\\.", " ", species)) |>
  ggplot(aes(x = xmean, xmin = xmean - xsd, xmax = xmean + xsd, 
             y = species, color = dataset)) +
  geom_linerange(position = position_dodge(0.5)) +
  geom_point(position = position_dodge(0.5), size = 2) +
  scale_color_manual(values = c("#e7b800", "#00afbb"), name = "Dataset") +
  guides(color = guide_legend(reverse = TRUE)) +
  facet_wrap(. ~ metric.eval, scales = "free_x") +
  theme(legend.position = "right", 
        axis.title = element_blank(),
        axis.text.y = element_text(face = "italic"))

## evaluation score of ensemble models
p2 <- list.files(
  path = "output/mod_eval",
  pattern = "ensemble_eval_scores",
  full.names = TRUE
) |>
  read_csv() |>
  separate(col = full.name, into = "species", sep = "_", 
           remove = TRUE, extra = "drop") |>
  mutate(species = gsub("\\.", " ", species)) |>
  ggplot(aes(x = calibration, y = species, fill = algo)) +
  geom_col(position = "dodge", width = 0.7) +
  facet_grid(. ~ metric.eval) +
  scale_fill_brewer(palette = "Paired", name = "Algorithm") +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  theme(legend.position = "right", 
        axis.title = element_blank(),
        axis.text.y = element_text(face = "italic"),
        strip.text = element_blank())

## arrange plots
ggpubr::ggarrange(
  p1, p2, ncol = 1, labels = c("a)", "b)"),
  label.x = 0, label.y = 0.975
)

# ## save to local disk
# ggsave("figs/03-eval_scores.pdf", width = 7, height = 6)
# ggsave("figs/03-eval_scores.png", width = 7, height = 6, dpi = 600)
```


Our individual models performed well and exhibited an average value of greater than 0.6 for both the metrics (AUC~ROC~ and TSS) on both calibration and validation datasets (@fig-eval-score). Across all models for all species, the model performance was higher for the calibration dataset (AUC~ROC~ = 0.97 &pm; 0.02 and TSS = 0.88 &pm; 0.05) as compared to the validation dataset (AUC~ROC~ = 0.94 &pm; 0.04 and TSS = 0.75 &pm; 0.16). Similarly, our ensemble models also performed well, scoring over 0.75 for considered metrics and algorithms across all species (@fig-eval-score).  Although both ensemble algorithms indicated equal performance, the committee averaging EMca algorithm (AUC~ROC~ = 0.96 &pm; 0.02 and TSS = 0.89 &pm; 0.05) appeared to provide a slightly better evaluation than the weighted mean averaging EMwmean algorithm (AUC~ROC~ = 0.95 &pm; 0.02 and TSS = 0.88 &pm; 0.05).

```{r}
# list.files(
#   path = "output/mod_eval",
#   pattern = "single_eval_scores",
#   full.names = TRUE
# ) |>
#   read_csv() |>
#   separate(col = full.name, into = "species", sep = "_", 
#            remove = TRUE, extra = "drop") |>
#   pivot_longer(cols = c("calibration", "validation"), 
#                names_to = "dataset", values_to = "x") |>
#   select(species, metric.eval, dataset, x) |>
#   group_by(metric.eval, dataset) |>
#   summarise(xmean = mean(x), xsd = sd(x)) |>
#   mutate(across(is.double, ~round(.x, 2))) |>
#   group_by(dataset) |>
#   gt::gt()
```

## Suitability change

Using our EMca ensemble model, we projected the model predictions over the spatial extent of our study area and across four climatic scenarios: 2010 (current), 2040, 2070, and 2100. The visual inspection of habitat suitability maps suggested substantial variation due to species and climatic scenarios (Appendix S1: Figure S5). The most prominent change in habitat suitability was observed for *Quercus semecarpifolia*, which is expected to lose the largest suitable area by this century. The predictions of our ensemble model suggested that most species are expected to both lose and gain suitability under future climatic conditions. However, the loss in habitat suitability is much higher than the gain in suitability, resulting in a net habitat loss for most selected species (@fig-perc-change). 

In our study area, an average of 32--40% pixels are expected to lose suitability across all species, whereas an average of only 3.6--8.2% pixels are expected to gain suitability, leading to an average net change of 28.8--32% pixels. Among the selected species, *Quercus semecarpifolia* (71--90%) is expected to lose the maximum suitable area followed by *Taxus wallichiana* (50--77%) and *Rhododendron arboreum* (37--55%) by the end of this century. On the other hand, *Shorea robusta* (3--37%) is predicted to gain maximum suitable area, followed by *Quercus leucotrichophora* (14--18%) and *Mallotus philippensis* (5--17%) by the end of this century. Nine of ten selected species are predicted to suffer a net loss of suitable habitat under future climatic conditions. Only *Shorea robusta* is expected to gain a net suitable habitat of up to 32% pixels by the end of the century (Appendix S1: Table S2).

```{r fig.width=7, fig.height=5}
#| label: fig-perc-change
#| fig-cap: Summary of predicted changes in species geographic range for each selected species in the Western Himalayas. The values represent the percentage of pixels expected to gain or lose species under future climatic conditions (2040, 2070, and 2100) compared to their near-current distribution in the study area.

list.files(
  path = "output/range_dynamics",
  pattern = "src_count.csv",
  full.names = TRUE
) |> 
  read_csv(id = "path") |>
  mutate(path = gsub("output/range_dynamics/|_current_to|_src_count.csv", "", path)) |>
  separate(path, into = c("species", "year"), sep = "_") |>
  filter(grepl("EMca", full.name)) |>
  mutate(species = gsub("\\.", "\n", species)) |>
  mutate(perc.level = case_when(
    perc.level == "PercGain" ~"Gain (%)",
    perc.level == "PercLoss" ~"Loss (%)",
    perc.level == "SpeciesRangeChange" ~"Net Change (%)"
  )) |>
  
  ggplot(aes(x = perc.value, y = species, fill = year)) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(values = scen_pal) +
  guides(fill = guide_legend(reverse = TRUE)) +
  facet_wrap(~ perc.level, scales = "free_x") +
  labs(x = "\nPixels (%)", y = "") +
  theme(legend.position = c(0.31, 0.01), legend.justification = c(1, 0),
        legend.title = element_blank(), legend.key.size = unit(0.25, "cm"),
        legend.background = element_rect(fill = NA, colour = "grey", linewidth = 0.25),
        axis.title = element_blank(),
        axis.text.y = element_text(face = "italic"))

## save to local disk
# ggsave("figs/04-percent_change.pdf", width = 7, height = 5)
# ggsave("figs/04-percent_change.png", width = 7, height = 5, dpi = 600)
```

The change in habitat suitability showed substantial spatial variation across tree species in the Western Himalayas (@fig-range-change). *Mallotus philippensis* indicated a loss in habitat suitability along the southwest edge of its distribution (foothills of the Himalayas), whereas substantial gain is expected in Uttarakhand by the end of this century. Our ensemble model predicted a small habitat patch for *Shorea robusta* in western Himachal Pradesh, which is expected to be lost by this century. This species is expected to gain suitable habitat in central and southern areas of Uttarakhand Himalayas. *Quercus leucotrichophora* is expected to gain suitable habitat in the Uttarakhand Himalayas. Despite some losses at range margins, the suitable habitat for *Pinus roxburghii* is expected to remain stable under future climates (@fig-range-change).

```{r}
## map species range change
# source("R/08-map_range_change.R")
```

![Map showing the spatial patterns of predicted changes in habitat suitability between near current and future climatic conditions (2040, 2070, and 2100) for selected tree species in the Western Himalayas.](figs/05-range_change){#fig-range-change}

## Species richness

```{r}
# read.csv("output/richness_elevation.csv") |>
#   count(scen, richness) |>
#   mutate(richness = case_when(richness <  0  ~"Loss",
#                               richness == 0  ~"Stable",
#                               richness >  0  ~"Gain"),
#          richness = factor(richness, c("Loss", "Stable", "Gain"))) |>
#   group_by(scen, richness) |>
#   summarise(n = sum(n)) |>
#   mutate(n_perc = n/sum(n)*100) |>
#   select(-n) |>
#   pivot_wider(names_from = scen, values_from = n_perc)
```

The stacking of individual EMca ensemble models suggested that the species richness (assemblage level habitat suitability) may undergo substantial changes under future climatic conditions (@fig-richness). More than half of the total pixels may experience changes in suitable habitat for at least one studied species under future climatic scenarios. Some pixels may lose suitable habitat for as many as four tree species, whereas others can gain suitable habitat for as many as seven. About 48--53% of pixels can gain suitable habitat, whereas about 3--6% can lose suitable habitat for at least one species compared to current climatic conditions. Thus, increasing species richness can be more apparent than decreasing under future climates (@fig-richness a). 

```{r fig.width=7, fig.height=8}
#| label: fig-richness
#| fig-cap: Predicted changes in (a) percentage of pixels, (b) elevational distribution, and (c) spatial distribution of assemblage level habitat suitability (&Delta; species richness) under future climatic conditions (2040, 2070, and 2100). 

## Western Himalayan States
wh <- st_read("data/site_states.gpkg", quiet = TRUE) |>
  filter(STATE %in% c("Himachal Pradesh", "Uttarakhand")) |>
  ## simplify geometry to 1 km buffer
  sf::st_simplify(preserveTopology = TRUE, dTolerance = 5e-3)

## species richness change and elevation
rich_change <- read.csv("output/richness_elevation.csv")

## plot of percent of pixels
p1 <- rich_change |>
  count(scen, richness) |>
  group_by(scen) |>
  mutate(n_perc = n/sum(n)*100) |>
  ggplot(aes(x = richness, y = n_perc, fill = richness)) +
  geom_bar(stat = "identity", color = "grey20", width = 0.8, linewidth = 0.2) +
  geom_text(aes(label = round(n_perc, 1), y = n_perc + 1.75), size = 1.75) +
  facet_wrap(.~scen) +
  scale_fill_gradient2(low = "#8c510a", mid = "#f5f5f5", high = "#01665e") +
  scale_x_continuous(breaks = seq(-4, 6, 2)) +

  labs(x = expression(Delta ~ "Species"), y = "Pixels (%)") +
  theme(legend.position = "none", 
        axis.title.x = element_blank())

## plot of elevation for richness change
p2 <- rich_change |>
  select(scen, richness, elevation) |>
  mutate(elevation = elevation/1e3) |>
  ggplot(aes(y = elevation, x = as.factor(richness), fill = richness)) +
  geom_boxplot(size = 0.25, outlier.alpha = 0.25, outlier.size = 0.75) +
  facet_wrap(.~scen) +
  scale_fill_gradient2(low = "#8c510a", mid = "#f5f5f5", high = "#01665e") +
  scale_x_discrete(breaks = seq(-4, 6, 2)) +

  labs(x = expression(Delta ~ "Species"), y = "Elevation (km)") +
  theme(legend.position = "none", 
        axis.title.x = element_blank(),
        strip.text = element_blank())
  
## plot change in species richness
p3 <- ggplot() +
  geom_raster(data = rich_change, aes(x, y, fill = richness)) +
  geom_sf(data = wh, color = "grey40", fill = NA, linewidth = 0.25) +
  
  facet_wrap(.~scen) +
  
  scale_x_continuous(NULL, expand = c(0, 0)) +
  scale_y_continuous(NULL, expand = c(0, 0)) +
  
  scale_fill_gradient2(
    low = "#8c510a", mid = "#f5f5f5", high = "#01665e", midpoint = 0,
    guide = guide_colourbar(title = expression(Delta ~ "Species richness"),
                            title.vjust = 1, label.position = "bottom",
                            barheight = 0.8, barwidth = 22,
                            ticks.colour = "grey10", frame.colour = "grey10")
  ) +
  
  theme(legend.position = "bottom",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        strip.text = element_blank())

## arrange plots
cowplot::plot_grid(
  p1, p2, p3,
  ncol = 1,
  align = "hv",
  rel_heights = c(0.3, 0.3, 0.4),
  labels = c("a)", "b)", "c)"),
  label_y = 0.97
)

## save the combined plots
# ggsave("figs/06-richness_change.pdf", width = 7, height = 8)
# ggsave("figs/06-richness_change.png", width = 7, height = 8, dpi = 600)
```

Further, the predicted assemblage level habitat suitability (species richness) suggested elevation-dependent changes in species richness under future climatic conditions (@fig-richness b). Generally, there will be little changes in species richness at lower elevations, whereas both positive and negative changes are expected at higher elevations. The magnitude of changes in species richness is expected to become more prominent towards higher elevations. With increasing elevation, the number of pixels indicating no change in species richness tended to decrease (Appendix S1: Figure S6). Generally, the pixels representing elevations lower than 1500 m indicated a stable species richness. However, the number of pixels indicating a positive or negative change showed an unimodal relationship with elevation. The maximum pixels losing species richness were between 1400 to 1600 m, and gaining species richness were between 1600 to 1800 m elevations. Further, the spatial patterns of changes in species richness also suggested that high-elevation regions are expected to gain species richness under future climatic conditions. The Uttarakhand Himalayas are predicted to experience more substantial changes than the Himachal Himalayas (@fig-richness c).

```{r}
# read.csv("output/richness_elevation.csv") |>
#   select(scen, richness, elevation) |>
#   filter(richness != 0) |>
#   mutate(elevation = cut(elevation, seq(0, 5000, 100), seq(100, 5000, 100)),
#          elevation = as.numeric(as.character(elevation))/1e3,
#          rich_cat = ifelse(richness > 0, "Gain", "Loss")) |>
#   group_by(elevation, rich_cat) |>
#   rstatix::get_summary_stats("richness") |>
#   filter(n > 30) |>
#   ggplot(aes(x = elevation, y = abs(mean), fill = rich_cat)) +
#   geom_bar(stat = "identity", width = 0.05, alpha = 0.75) +
#   facet_wrap(.~rich_cat, scales = "free") +
#   theme_grey() +
#   theme(legend.position = "none")
```


## Elevational shifting

The visual inspection of density plots indicated substantial changes in species elevation ranges under future climates. However, the changes in species elevational distribution appeared to vary due to species identity. The elevational range of most species depicted a more or less unimodal pattern except *Shorea robusta* whose elevational range is highly skewed towards lower elevations  (@fig-elev-density). Among the selected species, the most visible changes were observed for the average elevational range of *Lyonia ovalifolia*. 

The average elevation of predicted suitable pixels significantly varied due to climatic scenarios as indicated by type-II ANOVA (Appendix S1: Table S3). Further, the pairwise comparisons among the climatic scenarios suggested that the average elevation for all selected species is predicted to undergo significant changes under future climatic conditions. Thus, the statistical evidence from type-II ANOVA also supported our visual observations of elevation density plots. The average elevation of *Lyonia ovalifolia* is predicted to shift from 2278 m under current climates to 2475 m by the end of this century (Appendix S1: Table S4). 

```{r}
## plot elevation density
# source("R/09-plot_elev_density.R")
```

![Distribution of the elevational range of selected species under current and future climatic conditions (2040, 2070, and 2100). The pixel density was estimated using Silverman's rule-of-thumb bandwidth for the Gaussian kernel density estimator [@Silverman1986].](figs/07-elev_density){#fig-elev-density}


```{r}
## optimum elevation
elev_opt <- read_csv("output/suitability_elevation.csv", show_col_types = FALSE) |>
  ## build 100 m elevational bands
  mutate(elev_band  = cut(elevation, breaks = c(seq(0, 4900, 100), Inf),
                          labels = c(seq(100, 5000, 100)))) |>
  ## convert to numeric
  mutate(elev_band = as.character(elev_band),
         elev_band = as.numeric(elev_band)) |>
  ## count number of pixels
  group_by(species, scen) |>
  count(elev_band) |>
  ## filter elevational band with maximum pixels
  group_by(species, scen) |>
  filter(n == max(n)) |>
  select(-n) |>
  rename("Optimum.range" = elev_band)

## elevation range parameters (optimum and edges)
elev_range_param <- read_csv("output/suitability_elevation.csv", 
                             show_col_types = FALSE) |>
  left_join(elev_opt, by = join_by(species, scen)) |>
  group_by(species, scen) |>
  mutate(range_params = case_when(
    elevation < quantile(elevation, 0.05) ~"Trailing.edge",
    between(elevation, Optimum.range - 100, Optimum.range) ~"Optimum.range",
    elevation > quantile(elevation, 0.95) ~"Leading.edge",
    TRUE ~ "Other.range"
  )) |>
  select(-Optimum.range) |>
  filter(range_params != "Other.range")

## tukey's test for significance
tuk_trailing <- elev_range_param |>
  filter(range_params == "Trailing.edge") |>
  dplyr::group_by(species) |>
  tidyr::nest() |>
  rowwise() |> 
  dplyr::mutate(aov_results = list(lm(elevation ~ scen, data = data)), 
                emm = list(emmeans::emmeans(aov_results, "scen", type = "response")), 
                cld = list(multcomp::cld(emm, Letters = letters, reverse = FALSE))) |> 
  dplyr::select(-data, -aov_results, -emm)|> 
  unnest(cols = c(cld)) |>
  dplyr::mutate(cld.trailing = trimws(.group)) |> 
  dplyr::select(-.group) |>
  select(species, scen, emmean, cld.trailing)

## tukeys test for optimum range
tuk_optimum <- elev_range_param |>
  filter(range_params == "Optimum.range") |>
  dplyr::group_by(species) |>
  tidyr::nest() |>
  rowwise() |> 
  dplyr::mutate(aov_results = list(lm(elevation ~ scen, data = data)), 
                emm = list(emmeans::emmeans(aov_results, "scen", type= "response")), 
                cld = list(multcomp::cld(emm, Letters = LETTERS, reverse = FALSE))) |> 
  dplyr::select(-data, -aov_results, -emm)|> 
  unnest(cols = c(cld)) |>
  dplyr::mutate(cld = trimws(.group)) |> 
  dplyr::select(-.group)

## tukeys test for leading edge
tuk_leading <- elev_range_param |>
  filter(range_params == "Leading.edge") |>
  dplyr::group_by(species) |>
  tidyr::nest() |>
  rowwise() |> 
  dplyr::mutate(aov_results = list(lm(elevation ~ scen, data = data)), 
                emm = list(emmeans::emmeans(aov_results, "scen", type= "response")), 
                cld = list(multcomp::cld(emm, Letters = letters, reverse = FALSE))) |> 
  dplyr::select(-data, -aov_results, -emm)|> 
  unnest(cols = c(cld)) |>
  dplyr::mutate(cld.leading = trimws(.group)) |> 
  dplyr::select(-.group) |>
  select(species, scen, emmean, cld.leading)
```

The estimated range parameters (trailing edge, optimum range, and leading edge) for each species showed significant differences due to scenarios under current and future climatic conditions (Appendix S1: Table S5). Among all the range parameters for all species, only the optimum range for *Pinus roxburghii* showed non-significant (*F* = 0.317, *p* = 0.813) differences due to climatic scenarios (@fig-range-params). Across all species, the trailing edge and optimum range are generally predicted to display a positive increase, whereas the leading edge may show an overall neutral or negative change in elevation. The maximum shift in trailing edge was predicted for *Quercus lanata* followed by *Pinus roxburghii* and *Quercus semecarpifolia* (Appendix S1: Table S6). Similarly, the optimum range is predicted to shift upwards for all species except *Shorea robusta*. The highest shift in optimum range was predicted for *Lyonia ovalifolia* followed by *Cedrus deodara* and *Quercus leucotrichophora*. The most variable changes are predicted for leading edge across all species. The maximum positive shift in the leading edge was predicted for *Quercus leucotrichophora*, followed by *Lyonia ovalifolia* and *Mallotus philippensis*. Meanwhile, the maximum downward shift was predicted for *Quercus lanata* followed by *Quercus semecarpifolia* and *Pinus roxburghii*  (Appendix S1: Table S6).

```{r fig.width=7, fig.height=5}
#| label: fig-range-params
#| fig-cap: Comparison of range parameters for each species under current and future climatic conditions. The values represent the estimated marginal mean elevations using a general linear model. The points denote the mean of the optimum range, and the line range represents the mean value for the trailing and leading edges of the elevational range. The significance of the difference was determined using the t-test with Tukey's adjustment for multiple comparisons (equivalent to Tukey's test) and the shared letters for each species indicate non-significant (p > 0.05) differences under current and future climatic conditions. The small letters above and below the line range indicate differences in species' trailing and leading edges, respectively. The capital letters at the bottom indicate the differences in the optimum range.

tuk_optimum |>
  left_join(rename(tuk_trailing, "Trailing" = emmean), 
            by = join_by(species, scen)) |>
  left_join(rename(tuk_leading, "Leading" = emmean), 
            by = join_by(species, scen)) |>
  mutate(scen = factor(scen, c("current", "2040", "2070", "2100")),
         species = gsub("\\.", "\n", species)) |>
  
  ggplot(aes(y = emmean, ymin = Trailing, ymax = Leading, 
             x = reorder(species, emmean), 
             color = scen)) +
  geom_linerange(position = position_dodge(0.7)) +
  geom_point(position = position_dodge(0.7), size = 2.5) +
  geom_text(aes(label = cld), y = -500, size = 3,
            position = position_dodge(0.7), show.legend = FALSE) +
  geom_text(aes(label = cld.leading, y = Leading + 4500*0.025), 
            position = position_dodge(0.7), show.legend = FALSE) +
  geom_text(aes(label = cld.trailing, y = Trailing - 4500*0.025), 
            position = position_dodge(0.7), show.legend = FALSE) +
  scale_color_manual(values = scen_pal) +
  labs(x = "", y = "Elevation (m)") +
  lims(y = c(-500, 4500)) +
  theme(legend.position = c(0.01, 0.99), legend.justification = c(0, 1),
        legend.direction = "horizontal", legend.title = element_blank(),
        legend.background = element_rect(color = "grey", linewidth = 0.1, fill = NA),
        axis.text.x = element_text(face = "italic", angle = 45, hjust = 1, size = 9),
        panel.grid.major.y = element_line(color = "grey95", linewidth = 0.25))

## save the plots
# ggsave("figs/08-range_params.pdf", width = 7, height = 5)
# ggsave("figs/08-range_params.png", width = 7, height = 5, dpi = 600)
```

In general, the slope values exhibited a positive estimate for the trailing edge and optimum range, whereas it showed a negative estimate for the leading edge across all species (@fig-shift-slope). The slope values varied from 0.021 to 2.41 for the trailing edge, --0.03 to 4.35 for the optimum range, and --2.52 to 4.75 for the leading edge across all the selected ten species. The trailing edge generally showed a positive increase (mean = 1.28, SD = 0.73), whereas the leading edge showed highly variable responses (mean = 0.17, SD = 2.25). The leading edge of *Quercus leucotrichophora* showed a maximum value of slope estimate, whereas the optimum range for *Pinus roxburghii* displayed  a minimum value of slope estimate. The optimum range for *Pinus roxburghii*, *Quercus semecarpifolia*, *Shorea robusta* and *Taxus wallichiana* showed slope values close to zero. The linear regression analysis indicated a moderate statistical evidence for a positive shift in the trailing edge of *Taxus wallichiana* ($\beta$ = 1.71, *SE* = 0.31, *p* = 0.032). Further, the optimum range ($\beta$ = 4.35, *SE* = 0.56, *p* = 0.016) and leading edge ($\beta$ = 2.74, *SE* = 0.52, *p* = 0.034) of the *Lyonia ovalifolia* is expected to exhibit a significant upward shift (Appendix S1: Table S7). 

```{r}
df_trailing <- elev_range_param |>
  filter(range_params == "Trailing.edge") |>
  dplyr::group_by(species) |>
  tidyr::nest() |>
  rowwise() |> 
  dplyr::mutate(aov_results = list(lm(elevation ~ scen, data = data)), 
         emm = list(emmeans::emmeans(aov_results, "scen", type= "response")), 
         cld = list(multcomp::cld(emm, Letters = letters, reverse = FALSE))) |> 
  dplyr::select(-data, -aov_results, -emm)|> 
  unnest(cols = c(cld)) |>
  dplyr::mutate(cld = trimws(.group)) |> 
  dplyr::select(-.group) |> 
  select(species, scen, emmean) |>
  pivot_wider(names_from = scen, values_from = emmean) 

df_optimum <- elev_range_param |>
  filter(range_params == "Optimum.range") |>
  dplyr::group_by(species) |>
  tidyr::nest() |>
  rowwise() |> 
  dplyr::mutate(aov_results = list(lm(elevation ~ scen, data = data)), 
         emm = list(emmeans::emmeans(aov_results, "scen", type= "response")), 
         cld = list(multcomp::cld(emm, Letters = LETTERS, reverse = FALSE))) |> 
  dplyr::select(-data, -aov_results, -emm)|> 
  unnest(cols = c(cld)) |>
  dplyr::mutate(cld = trimws(.group)) |> 
  dplyr::select(-.group) |> 
  select(species, scen, emmean) |>
  pivot_wider(names_from = scen, values_from = emmean)

df_leading <- elev_range_param |>
  filter(range_params == "Leading.edge") |>
  dplyr::group_by(species) |>
  tidyr::nest() |>
  rowwise() |> 
  dplyr::mutate(aov_results = list(lm(elevation ~ scen, data = data)), 
         emm = list(emmeans::emmeans(aov_results, "scen", type= "response")), 
         cld = list(multcomp::cld(emm, Letters = letters, reverse = FALSE))) |> 
  dplyr::select(-data, -aov_results, -emm)|> 
  unnest(cols = c(cld)) |>
  dplyr::mutate(cld = trimws(.group)) |> 
  dplyr::select(-.group) |> 
  select(species, scen, emmean) |>
  pivot_wider(names_from = scen, values_from = emmean)
```

```{r fig.width=7, fig.height=5}
#| label: fig-shift-slope
#| fig-cap: Elevational changes in species range parameters due to current (2010) and future (2040, 2070, and 2100) climatic conditions. The values are estimated slope values with associated standard errors (SE) from linear regression of marginal means against the years representing climatic conditions. The asterisks indicate that the slope value is significantly different from zero at a 0.05 significance level.


bind_rows(
  mutate(df_trailing, Metric = "Trailing.edge"),
  mutate(df_optimum, Metric = "Optimum.range"),
  mutate(df_leading, Metric = "Leading.edge")
) |> 
  pivot_longer(cols = c(current, `2040`, `2070`, `2100`), 
               names_to = "scen", values_to = "Elevation") |>
  mutate(scen = ifelse(scen == "current", "2010", scen),
         scen = as.numeric(scen)) |>
  
  group_by(species, Metric) |>
  nest() |>
  mutate(Model = map(data, ~lm(Elevation ~ scen, data = .x) |> broom::tidy())
         ) |> 
  select(-data) |>
  unnest(Model) |>
  filter(term == "scen") |>
  mutate(p.lab = case_when(
    p.value > 0.05 ~"",
    p.value < 0.05 ~"*",
    between(p.value, 0.001, 0.05) ~"**",
    p.value < 0.001 ~"***"
  )) |>
  mutate(species = gsub("\\.", "\n", species),
         Metric = gsub("\\.", " ", Metric),
         Metric = factor(Metric, c("Trailing edge", "Optimum range", "Leading edge"))) |>
  
  ggplot(aes(y = estimate, x = species, color = Metric,
             ymin = estimate - std.error, ymax = estimate + std.error)) +
  geom_bar(aes(fill = Metric), stat = "identity", color = NA, 
           position = position_dodge(0.7), width = 0.7) +
  geom_linerange(position = position_dodge(0.7)) +
  geom_point(position = position_dodge(0.7), size = 2.5) +
  geom_text(aes(label = p.lab, y = estimate + std.error + 0.25), 
            position = position_dodge(0.7), size = 5, show.legend = FALSE) +
  scale_color_manual(values = c("Trailing edge" = "#D55E00",
                               "Optimum range" = "#999999",
                               "Leading edge"  = "#0072b2"
                               )) +
  scale_fill_manual(values = c("Trailing edge" = "#fff2e9",
                               "Optimum range" = "#f2f2f2",
                               "Leading edge"  = "#d9f1ff"
                               )) +
  labs(x = "", y = "Slope estimate") +
  lims(y = c(-3.5, 8)) +
  theme(legend.position = c(0.99, 0.98), legend.justification = c(1, 1),
        legend.title = element_blank(), legend.direction = "horizontal",
        legend.background = element_rect(fill = NA, color = "lightgrey", linewidth = 0.25),
        axis.text.x = element_text(angle = 45, face = "italic", hjust = 1))

## save the plot
# ggsave("figs/09-elev_shift.pdf", width = 7, height = 5)
# ggsave("figs/09-elev_shift.png", width = 7, height = 5, dpi = 600)
```

```{r}
# bind_rows(
#   mutate(df_trailing, Metric = "Trailing.edge"),
#   mutate(df_optimum, Metric = "Optimum.range"),
#   mutate(df_leading, Metric = "Leading.edge")
# ) |> 
#   pivot_longer(cols = c(current, `2040`, `2070`, `2100`), 
#                names_to = "scen", values_to = "Elevation") |>
#   mutate(scen = ifelse(scen == "current", "2010", scen),
#          scen = as.numeric(scen)) |>
#   
#   group_by(species, Metric) |>
#   nest() |>
#   mutate(Model = map(data, ~lm(Elevation ~ scen, data = .x) |> broom::tidy())
#          ) |> 
#   select(-data) |>
#   unnest(Model) |>
#   filter(term == "scen") |>
#   mutate(p.lab = case_when(
#     p.value > 0.05 ~"",
#     p.value < 0.05 ~"*",
#     between(p.value, 0.001, 0.05) ~"**",
#     p.value < 0.001 ~"***"
#   )) |>
#   ungroup() |>
#   mutate(Metric = factor(Metric, c("Trailing.edge", "Optimum.range", "Leading.edge"))) |>
#   group_by(Metric) |>
#   rstatix::get_summary_stats(estimate, type = "common")
```


## Variable importance

```{r}
# ## variable importance for individual models
# list.files(
#   path = "output/mod_eval",
#   pattern = "single_var_imp",
#   full.names = TRUE
# ) |>
#   read_csv() |>
#   separate(col = full.name, into = "species", sep = "_",
#            remove = TRUE, extra = "drop") |>
#   select(species, expl.var, var.imp) |>
#   mutate(species = gsub("\\.", " ", species)) |>
#   bind_rows(rename(vrimp_ens, "var.imp" = Ensemble)) |>
#   mutate(clim = ifelse(expl.var %in% c("bio2", "bio3", "bio8"), "Temp", "Prec")) |>
#   # group_by(clim) |> ## across all species and temperature and precipitation
#   # group_by(expl.var) |> ## across all species
#   # group_by(expl.var, species) |> ## across all species and expl.var
#   summarise(vi.mean = mean(var.imp)) |>
#   arrange(desc(vi.mean))
```

The importance of environmental variables remained coherent between individual models and ensemble models for each species (@fig-var-imp). On average, the temperature-related variables were more important than the precipitation-related variables in determining the habitat suitability of tree species. Across all species and all models, the temperature of the wettest quarter (bio8) appeared to be most influential, followed by the temperature isothermality (bio3). Among the precipitation-related variables, precipitation seasonality (bio15) and precipitation of the driest month (bio14) were influential, whereas the precipitation amount of the warmest quarter (bio18) had little effect on habitat suitability. However, the importance of variables substantially varied due to species. For example, the precipitation seasonality (bio15) has the highest influence on the habitat suitability of *Shorea robusta*, followed by the temperature of the wettest quarter (bio8) for *Quercus semecarpifolia* among all the species (@fig-var-imp).

```{r fig.width=7, fig.height=5}
#| label: fig-var-imp
#| fig-cap: Importance of different environmental variables used to model habitat suitability of selected species. The horizontal bars represent the mean variable importance for ensemble models (n &equals; 2). The points and linerange indicate the mean variable importance and associated standard deviation  for individual models (n &equals; 12). Temperature-related variables are shown in red, and precipitation-related variables are shown in blue. Higher scores indicate the importance of variables in determining habitat suitability.

## variable importance for ensemble model
vrimp_ens <- list.files(
  path = "output/mod_eval",
  pattern = "ensemble_var_imp",
  full.names = TRUE
) |>
  read_csv() |>
  separate(col = full.name, into = "species", sep = "_", 
           remove = TRUE, extra = "drop") |>
  mutate(species = gsub("\\.", " ", species)) |>
  group_by(species, expl.var) |>
  summarise(Ensemble = mean(var.imp))

## variable importance for individual models
list.files(
  path = "output/mod_eval",
  pattern = "single_var_imp",
  full.names = TRUE
) |>
  read_csv() |>
  separate(col = full.name, into = "species", sep = "_", 
           remove = TRUE, extra = "drop") |>
  mutate(species = gsub("\\.", " ", species)) |>
  group_by(species, expl.var) |>
  summarise(vi.mean = mean(var.imp), vi.sd = sd(var.imp)) |>
  ## join ensemble var imp
  left_join(vrimp_ens, by = join_by(species, expl.var)) |>
  mutate(expl.var = factor(expl.var, paste0("bio", c(2, 3, 8, 14, 15, 18))),
         clim = ifelse(expl.var %in% c("bio2", "bio3", "bio8"), "Temp", "Prec")) |>
  
  ## plot graph
  ggplot(aes(x = vi.mean, y = expl.var, 
             xmin = vi.mean - vi.sd, xmax = vi.mean + vi.sd,
             color = clim, fill = clim)) +
  geom_col(aes(x = Ensemble), width = 0.7, color = NA) +
  geom_linerange() +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_manual(values = c("Temp" = "#fceeee", "Prec" = "#ecf1f8")) +
  scale_color_manual(values = c("Temp" = "#d73027", "Prec" = "#4575b4")) +
  facet_wrap(.~species, ncol = 4) +
  theme(legend.position = "none", axis.title = element_blank(),
        strip.text = element_text(hjust = 0, face = "italic", size = 8.5))

## save the plot
# ggsave("figs/10-var_imp.pdf", width = 7, height = 5)
# ggsave("figs/10-var_imp.png", width = 7, height = 5, dpi = 600)
```

The smoothed response curves from individual models revealed that each species had variable responses to environmental variables (Appendix S1: Figure S7). Temperature-related variables limit the distribution of suitable habitats for most species, except *Shorea robusta*. In general, the habitat suitability tends to increase with a decrease in the diurnal temperature range. Further, many species indicated an optimum range of environmental variables where the habitat suitability is maximised. It appears that most of the species survive well in environmental conditions with a lower diurnal temperature range (<10&deg;C), higher isothermality (0.35--0.45&deg;C) and higher precipitation seasonality (100--150 mm). However, the likelihood of presence for some species like *Shorea robusta* showed little variation due to selected environmental variables. In the case of *Shorea robusta*, the habitat suitability increased with increasing levels of precipitation seasonality (@fig-resp-curve).

```{r fig.width=7, fig.height=5}
#| label: fig-resp-curve
#| fig-cap: Plot of the response curves of six environmental variables used to model habitat suitability of selected species. The lines represent the fitted smooth line across the predictions of 14 evaluated models (12 individual + 2 ensemble models). The smooth line was fitted using the generalized additive model (GAM) with a shrinkage version of the penalized cubic spline. Temperature-related variables are shown with solid lines in shades of red, and precipitation-related variables are shown with dashed lines in shades of blue. The environmental variable values were scaled to mean zero and unit standard deviation.


## response curves for ensemble models
ens_resp_curv <- list.files(
  path = "output/mod_eval",
  pattern = "ensemble_resp_curve.csv",
  full.names = TRUE
) |>
  read_csv() |>
  separate(pred.name, into = c("species", "algo"), sep = "_", extra = "drop") |>
  rename("Model" = algo)

## define line types for biovars
expl.lty <- rep(c("solid", "dashed"), each = 3)
names(expl.lty) <- paste0("bio", c(2, 3, 8, 14, 15, 18))

## single model response curves
list.files(
  path = "output/mod_eval",
  pattern = "single_resp_curve.csv",
  full.names = TRUE
) |>
  read_csv() |>
  separate(pred.name, into = c("species", "PA", "RUN"), sep = "_", extra = "drop") |>
  unite("Model", PA, RUN, sep = "_") |>
  
  ## add ensemble model response curves
  bind_rows(ens_resp_curv) |>
  
  ## scales values of explanatory variables
  group_by(expl.name, species, Model) |>
  mutate(expl.val = scale(expl.val)) |>
  
  ## arrange and divide into Temperature and Precipitation
  mutate(expl.name = factor(expl.name, paste0("bio", c(2, 3, 8, 14, 15, 18))),
         expl.clim = ifelse(expl.name %in% c("bio2", "bio3", "bio8"), 
                            yes = "ATemp", no = "BPrec")) |>
  
  ## format species name to have space
  mutate(species = gsub("\\.", " ", species)) |>
  
  ## plot the response curves
  ggplot(aes(x = expl.val, y = pred.val, linetype = expl.clim,
             color = expl.name, fill = expl.name)) +
  geom_hline(yintercept = 0.5, color = "lightgrey", linewidth = 0.25) +
  geom_smooth(alpha = 0.1, se = FALSE, method = "gam", 
              formula = y ~ s(x, bs = "cs")) +
  scale_color_brewer(palette = "RdYlBu", name = "Variable") +
  scale_fill_brewer( palette = "RdYlBu", name = "Variable") +
  guides(fill  = guide_legend(nrow = 2, byrow=TRUE),
         color = guide_legend(nrow = 2, byrow=TRUE,
                              override.aes = list(linetype = expl.lty))
         ) +
  scale_linetype(guide = FALSE) +
  facet_wrap(.~species) +
  theme(legend.position = c(0.98, 0.02), legend.justification = c(1, 0),
        legend.background = element_rect(color = "grey"),
        legend.title = element_blank(), legend.key.width = unit(1, "cm"),
        axis.title = element_blank(),
        strip.text = element_text(hjust = 0, face = "italic", size = 8.5))

## save the plots
# ggsave("figs/11-resp_curve.pdf", width = 7, height = 5)
# ggsave("figs/11-resp_curve.png", width = 7, height = 5, dpi = 600)
```


# Discussion

The present study focused on the climate-related shifts in the elevational distribution of dominant tree species in the Western Himalayas. Our results suggested substantial variation in habitat suitability for different species over space and time. Consequently, the geographic area of suitable habitats is expected to undergo positive and negative changes under future climatic conditions (Aim 1). Further, the predicted changes in range margins and optimum range revealed variable responses of species to climate change (Aim 2). These range dynamics suggest that some species are more vulnerable to climate change, and their elevational distribution is expected to undergo more severe changes than others. Furthermore, the species richness (assemblage level habitat suitability) is expected to undergo positive and negative changes for more than half of the analyzed pixels. The higher elevation regions will be more vulnerable, and positive changes will be more prominent than negative changes in species richness (Aim 3). Finally, our study identified the probable species-specific environmental variables that regulate the distribution dynamics of dominant trees in the Western Himalayas (Aim 4). Overall, our findings contribute to understanding the elevational dynamics of species distributions due to projected changes in climatic conditions. Additionally, this study highlighted the climatic vulnerabilities of dominant tree species in the Western Himalayas. We show that climatic changes may cause a substantial decline in suitable habitats for dominant tree species. This decline in suitable habitat is also reflected by range contractions indicating the trajectory towards extinctions under expected future climatic conditions. This information will be useful for developing better management plans and mitigating the projected effects of climate change on mountain biodiversity.

## Range dynamics

Perhaps this study is one of the first to investigate the elevational range dynamics for dominant tree species in the Western Himalayas. While many studies assessed the changes in predicted habitat suitability for Himalayan trees [@Bobrowski2021], very few investigated the elevational range dynamics under future climatic conditions [@Maharjan2023]. In this study, we went beyond assessing the changes in suitable habitat areas and investigated the elevational dynamics of range limits and optimum range for dominant trees in the Western Himalayas. 

```{r}
# tribble(
#   ~Species,                 ~Range,                    ~Rate,
#   "Cedrus deodara",         (1321-1463) + (2923-3016), (1.54 + 0.94)/2,
#   "Pinus roxburghii",       ( 919-1110) + (2686-2848), (1.98 + 1.64)/2,
#   "Quercus lanata",         (1007-1221) + (3301-3545), (2.41 + 2.52)/2,
#   "Quercus semecarpifolia", (2008-2181) + (3633-3814), (1.50 + 1.77)/2,
#   "Rhododendron arboreum",  (1500-1632) + (3331-3432), (1.31 + 0.97)/2
# ) |>
#   arrange(Range)
```

Our most important finding is the prediction of moderate to severe range contractions for half of the investigated tree species in the Western Himalayas. Such climate-associated contractions of elevational ranges of plants have been previously documented [@Zu2021]. We showed that *Cedrus deodara*, *Pinus roxburghii*, *Quercus lanata*, *Quercus semecarpifolia*, and *Rhododendron arboreum* may contract their elevational ranges under future climatic conditions (@fig-shift-slope). The elevational range of these species indicated an upward shift in the trailing edge and a downward shift in the leading edge, resulting in a net contraction of their elevational ranges. These species may lose an average of 230--450 m of their current elevational range by 2100 at an average rate of 11--24 m per decade (Appendix S1: Table S6 and Table S7). Although we are not aware of any study that directly investigated the range dynamics in the Western Himalayas, our findings are supported by earlier studies indicating a decrease in suitable habitat for *Cedrus deodara* [@Chitale2019], *Pinus roxburghii* [@Chitale2019], *Quercus semecarpifolia* [@Chakraborty2016; @Rathore2019a; @Saran2010], and *Rhododendron arboreum* [@Chitale2019]. Apart from suitability modeling studies, the range contraction for some of these trees is also supported by previous studies reporting limited regeneration indicated by declining densities of seedlings and saplings in the Western Himalayas [@Negi2021; @Singh1997; @Thakur2021]. Further, dendrochronological studies also supported our observation of declining distribution for *Cedrus deodara* under a warming climate [@Bhattacharyya2023]. 

However, our findings of range contractions are contrary to the predictions of previous studies for *Cedrus deodara* [@Xiao2022], *Pinus roxburghii* [@Chakraborty2016; @Dad2023], *Quercus lanata* [@Bhandari2020], *Quercus semecarpifolia* [@Chitale2019], and *Rhododendron arboreum* [@Veera2019] indicating positive or little change in habitat suitability. Our study indicated that the elevational range of *Quercus semecarpifolia* is expected to contract by more than 350 m, and the optimum range is expected to shift 300 m upwards by the end of this century (Appendix S1: Table S6). This finding is contrary to the observations of earlier studies suggesting a downward [@Chakraborty2016], upward shift [@Shekhar2022], or little changes [@Chitale2019; @Rathore2019a] in its elevational distribution. Similarly, we predicted that *Rhododendron arboreum* may lose about 230 meters of its elevational range by 2100 at an average rate of 11.4 meters per century (Appendix S1: Table S6 and Table S7). However, a recent study suggested that the distribution of this species can shift upward under future climatic conditions [@Veera2019]. The variations in results of different studies on the same taxa in a similar region indicate species' complex responses to climate change. Further, the results of modeling studies are influenced by multiple factors, including the predictors, modeling techniques, sample size, and study area. Therefore, it is imperative to report the modeling procedures accurately, and the results of species distribution models should be carefully interpreted [@Zurell2020].

```{r}
# tribble(
#   ~Species,                   ~Range,                      ~Rate,
#   "Lyonia ovalifolia",        (1563-1431) + (3610-3356)/2, (0.64 + 4.35 + 2.74)/3,
#   "Mallotus philippensis",    ( 372- 273) + (1743-1640)/2, (0.43 + 1.33 + 1.26)/3,
#   "Quercus leucotrichophora", (1658-1542) + (3235-2802)/2, (1.27 + 1.99 + 4.76)/3
# ) |>
#   arrange(Range)
```

On the other hand, *Lyonia ovalifolia*, *Mallotus philippensis*, and *Quercus leucotrichophora* are expected to shift their elevational distribution towards higher elevations. This finding aligns with previous  Himalayan studies indicating that some species may shift their distributions toward higher elevations in response to climate change [@Maharjan2023; @Telwala2013]. We found that the elevational distribution of *Quercus leucotrichophora* can shift about 330 meters upwards under projected changes in climate. This prediction is supported by earlier studies also indicating a north-eastern or upward shift in its distribution [@Chakraborty2016; @Khan2023; @Rathore2019a]. However, the magnitude of shift will be stronger for the leading edge than the trailing edge or optimum range (@fig-shift-slope). 

Perhaps this is one of the first studies that predicted the range dynamics and habitat suitability for *Lyonia ovalifolia* and *Mallotus philippensis* in the Western Himalayas. Our study indicated that *Mallotus philippensis* can shift its distribution 150 meters upward, whereas *Lyonia ovalifolia* is expected to shift its distribution about 260 meters upward under the projected climatic conditions. Further, the magnitude of the elevational shift will be higher for the optimum range than their trailing or leading edges. The optimum range can shift at an average rate of 43.5 and 13.3 m/decade for *Lyonia ovalifolia* and *Mallotus philippensis*, respectively (@fig-shift-slope). Since *Mallotus philippensis* is a low-elevation species and *Lyonia ovalifolia* is a high-elevation species, high-elevation species may experience greater influence of climate change than low-elevation species. Therefore, high-elevation species can be more prone to extinction than low-elevation species due to changing climatic conditions.

Our study showed that the elevational range of *Shorea robusta* and *Taxus wallichiana* may lean towards higher elevations. Given that the optimum range for these species will remain similar, the upward shift in the leading edge of *Shorea robusta* and trailing edge of *Taxus wallichiana* will lead to the elevational range leaning towards higher elevations. We show that the leading edge of *Shorea robusta* may shift 20 m upwards by the end of this century (Appendix S1: Table S6), while the trailing edge and optimum range will remain similar. This finding aligns with earlier studies indicating that the overall distribution of *Shorea robusta* may shift towards the north and north-eastern parts of India [@Chitale2012]. However, our prediction of range leaning does not agree with the prediction of a recent study indicating a decline in suitable habitats for this tree species [@Kaur2023]. On the other hand, the trailing edge of *Taxus wallichiana* is expected to shift significantly upwards at an average rate of 17 m/decade, while the leading edge and optimum range remain similar under future climatic conditions (Appendix S1: Table S7). This range leaning is supported by the reduction in suitable habitats in this study and previous studies [@Rathore2019b].

One notable finding of this study is the variation in responses of elevational ranges to climate change for different species. The changes in the elevational range showed high variation due to species and climatic conditions. This finding is consistent with earlier studies documenting idiosyncratic responses of elevational range dynamics to climate change [@Chen2011; @Freeman2018; @Lenoir2008; @Mamantov2021; @Rumpf2018]. Previous studies suggested that the trailing and leading edges of the elevational range are shifting at similar rates in response to climate change [@Freeman2018; @Rumpf2019]. However, our findings indicated that the magnitude of change is highly variable for trailing and leading edges of elevational ranges. While the trailing edge indicated an upward shift for all investigated species [@Maharjan2023; @Telwala2013], the leading edge showed a downward shift in elevation for half of the investigated species. These observations contradict the expectation that cooler limits (leading edge) are more sensitive to temperature changes than warmer limits (trailing edge). Instead, our study supports that the warmer limits (trailing edge) may be more sensitive to climatic changes, indicating that physiological tolerances are more important in determining species distributions [@Cahill2014].

## Suitable habitat

Our results showed that the suitable habitat will vary due to species and climate change scenarios. Generally, the change in suitable habitat will become stronger with projected changes in climate conditions. Although habitat suitability can increase or decrease with climate change, the loss of suitable habitats will be more pronounced than the gain in the Western Himalayas. Therefore, many species will experience a net decline in suitable habitat over time if current rates of climate change continue. Our study predicted a net loss in suitable habitats for all the investigated tree species except *Shorea robusta*, which indicated a net gain in suitable habitats under projected climate change. These predictions align with previous studies in Himalayas indicating moderate to severe decline in suitable habitats for *Cedrus deodara* [@Chitale2019; @Dad2023], *Pinus roxburghii* [@Chitale2019], *Quercus leucotrichophora* [@Chakraborty2016; @Dhyani2020; @Khan2023; @Rathore2019a], *Quercus semecarpifolia* [@Chakraborty2016; @Rathore2019a; @Saran2010; @Shekhar2022], *Rhododendron arboreum* [@Chitale2019], and *Taxus wallichiana* [@Dad2023; @Li2020; @Rathore2019b]. Among all ten investigated tree species, only *Shorea robusta* is predicted to gain suitable habitat by the end of this century under projected climatic scenarios. We predicted a net loss of suitable habitat by 2040 and a gain by 2100 for *Shorea robusta* in the Western Himalayas. This finding aligns with a recent study suggesting improvement in suitable habitat from 2060 to 2080 [@Kaur2023].

```{r}
# tribble(
#   ~Species, ~LL, ~UL,
#   "Cedrus deodara", -27, -41,
#   "Lyonia ovalifolia", -21, -24,
#   "Mallotus philippensis", -0.6, -13,
#   "Pinus roxburghii", -19, -27,
#   "Quercus lanata", -21, -32,
#   "Quercus leucotrichophora", -6, -15,
#   "Quercus semecarpifolia", -71, -90,
#   "Rhododendron arboreum", -36, -55,
#   "Shorea robusta", -25, 32,
#   "Taxus wallichiana", -49, -77
# )
```

However, our study indicated substantial differences in the magnitude of predicted loss compared to earlier studies in the Himalayas. For instance, we observed a much higher magnitude of loss in suitable habitats than the previous studies for *Quercus semecarpifolia* [@Rathore2019a; @Saran2010] and *Taxus wallichiana* [@Rathore2019b]. On the other hand, our predictions are much smaller for *Quercus leucotrichophora* as compared to previous studies indicating 60--99% loss in suitable habitat [@Dhyani2020; @Rathore2019a]. Further, our findings did not agree with previous studies indicating a gain or little change in habitat suitability for *Pinus roxburghii* [@Chakraborty2016; @Dad2023], *Quercus lanata* [@Barman2023; @Bhandari2020], *Quercus leucotrichophora* [@Khan2023; @Naudiyal2021], *Quercus semecarpifolia* [@Chitale2019], *Rhododendron arboreum* [@Veera2019]. These variations in modeling results may arise due to differences in the modeling parameters, predictors, and spatial scale of the target region. Therefore, caution must be exercised while interpreting or comparing the predictions of habitat suitability studies.

## Species richness

Since species responses to climate change can be highly asynchronous and idiosyncratic, climate-driven redistribution of plants will eventually alter species richness [@Bonebrake2018; @Pecl2017]. Our investigation also suggested substantial changes in assemblage-level habitat suitability (species richness) under future climatic conditions. These changes will be more prominent in higher elevations than in lower elevations. This finding highlights the vulnerability of high-elevation ecosystems due to climate change [@Thuiller2005]. Further, we showed that the gains in species richness will be more widespread than the corresponding loss in the Western Himalayas. This finding is consistent with earlier studies suggesting a general increase in species richness under projected climate change [@Sommer2010; @Thuiller2005].

Although the changes in species richness varied with elevation, species gains were prominent at higher elevations and species losses at lower elevations [@Sommer2010]. The increased species richness towards high-elevation regions may be due to low extinction and immigration of other species [@Sommer2010; @Thuiller2005]. This increase in species richness suggests that the ability of species to track climate change may decrease with elevation [@Lenoir2020; @Rumpf2018]. Consequently, the faster migration of low-elevation species and slower migration of high-elevation species might have increased species richness at higher elevations. Considering the upward migration of trees, the current extent of grasslands may be replaced by forests under future climatic conditions. Such changes in species distribution have consequences for species interactions, which may form novel ecosystems with unknown structures and functions [@Bonebrake2018; @Pecl2017].

## Climatic variables

```{r}
# list.files(
#   path = "output/mod_eval",
#   pattern = "ensemble_var_imp",
#   full.names = TRUE
# ) |>
#   read_csv() |>
#   separate(col = full.name, into = "species", sep = "_", 
#            remove = TRUE, extra = "drop") |>
#   mutate(species = gsub("\\.", " ", species)) |>
#   group_by(species, expl.var) |>
#   summarise(Ensemble = mean(var.imp)) |>
#   mutate(expl.var = factor(expl.var, paste0("bio", c(2, 3, 8, 14, 15, 18)))) |>
#   ggplot(aes(x = expl.var, y = species, fill = Ensemble)) +
#   geom_tile(color = "white") +
#   geom_text(aes(label = round(Ensemble, 1)), color = "white") +
#   scale_fill_viridis_b(option = "D") +
#   theme_minimal(base_size = 14) +
#   theme(axis.text.y = element_text(face = "italic"),
#         axis.title = element_blank(),
#         legend.position = "none")
```

The relative importance of climatic variables varied substantially among the species, indicating differences in the climatic niche of Himalayan trees. Our study suggested that temperature-related variables may influence the distribution of Himalayan trees more than the precipitation-related variables (@fig-var-imp). Among the selected climatic variables, the temperature of the wettest quarter (bio8) can be an important variable regulating the distribution dynamics of Himalayan trees. However, this variable (bio8) was highly correlated with bioclimatic variables. Further, our study used only six temperature- and precipitation-related bioclimatic variables. Therefore, it is difficult to say whether this variable is really important for tree distribution in the Himalayas. Although species distribution modeling studies are growing for Himalayan taxa [@Bobrowski2021], our knowledge about the environmental determinants of species distribution remains limited. Perhaps a major challenge is the selection of environmental variables [@Bradie2017], which is complicated by the inter-correlation between predictor variables [@Dormann2013]. 

Contrary to the traditional practice of analyzing and interpreting the response curves separately, our simultaneous consideration of all environmental variables revealed suitable climatic space for Himalayan trees. We found that the habitat suitability for most of the trees increased at a lower mean diurnal air temperature range (bio2 < 11) and higher isothermality (bio3 > 0.35), higher precipitation amount of the driest month (bio14 > 20) and higher precipitation seasonality (bio15 > 100). The shapes of response curves for *Mallotus philippensis* and *Shorea robusta* separated them from the other subtropical to temperate Himalayan trees. Interestingly, our study suggested that the habitat suitability for *Shorea robusta* was only influenced by precipitation seasonality (bio15). Although the importance of precipitation seasonality agrees with a recent study in the Western Himalayas [@Kaur2023], our observation of the little or no influence of other climatic variables is contrary to the findings of this study.

## Implications and Limitations

In response to climate change, species redistributions can seriously affect biodiversity, ecosystem sustainability, and human health [@Bonebrake2018; @Pecl2017]. Therefore, we need a forward-thinking approach to species management that balances current and future demands while remaining resilient to climate change. Our study predicted moderate to severe range contractions for *Cedrus deodara*, *Pinus roxburghii*, *Quercus lanata*, *Quercus semecarpifolia*, and *Rhododendron arboreum* under the projected climate change in the Western Himalayas. This information can help prioritize conservation efforts and develop management plans to mitigate the effects of climate change on forest ecosystems in the Western Himalayas. For instance, future biodiversity management plans may consider habitat protection, restoration, and assisted migration to maintain the vulnerable species. 

Additionally, some species, like *Lyonia ovalifolia*, *Mallotus philippensis*, and *Quercus leucotrichophora*, may track changes in climate by shifting their distribution to higher elevations. However, the range shifts can be highly asynchronous due to differences in the dispersal capacities of species. Such asynchronous range shifts will result in altered species composition, disruption of ecological interactions, and formation of novel communities with unknown consequences [@Hobbs2009]. Further, we revealed the spatio-temporal changes in suitable habitats for dominant trees in the Western Himalayas. An important observation was predicted net loss in suitable habitat for *Quercus semecarpifolia* and *Taxus wallichiana* at higher elevation regions in Himachal Pradesh and Uttarakhand states. Overall, our study will contribute to ensuring that our conservation efforts survive and thrive in a changing climate.

Despite its contribution, our study shares the assumptions and limitations of species distribution modeling [@Guisan2017; @Soley-Guardia2024]. Species distribution models do not consider the dispersal limitations and biotic interactions, which are crucial for determining the actual distribution of a species. Also, the species' evolutionary capabilities to adapt to changing environments are neglected in species distribution models. Therefore, the predictions should be interpreted in terms of suitable habitat rather than the actual presence or absence of the species [@Guisan2017]. Apart from these inherent limitations, the quality of input data may affect the reliability of the predictions. In this study, we combined the species occurrence data from published literature and the GBIF platform, which relies on citizen science. Therefore, the uncertainty of species identification and location accuracy may influence our results [@Soley-Guardia2024]. Additionally, the bioclimatic data used in this study is developed through statistical modeling [@Karger2017] and therefore, its validity in real-life applications may be compromised. Further, we assumed that our selected bioclimatic variables would be the primary drivers of the distribution dynamics of species responses to climate change. Therefore, our results can vary with further inclusion of ecologically meaningful predictors [@Groner2022]. 


# Conclusion

In this study, we went beyond the habitat suitability predictions under future climatic conditions. Although habitat suitability maps are valuable, understanding species range dynamics can provide valuable insights for effective biodiversity management. This approach can be helpful in understanding how changes at range margins and optimum range can influence the overall species distribution dynamics under future climatic conditions. Our study highlighted the use of ecological modeling to investigate climate-related changes in species distributions. Despite its limitations, it can provide valuable information if a distribution is carefully modelled.

Contrary to a general expectation of synchronous upward shifts in elevational distributions, our study indicates that many species may contract or lean their elevational ranges in response to climate change. These idiosyncratic climate responses can potentially alter mountain’s ecological communities. Further, climate change is likely to cause a net decline in suitable habitat for most tree species, though the magnitude will vary with species. Our study will contribute to developing informed management plans for safeguarding species and ensuring ecosystem functioning and sustainability.


# Acknowledgements {.unnumbered}

We are also thankful to the Chairperson, Department of Botany, Panjab University, Chandigarh, for providing all the necessary facilities required for the work. We want to express our heartfelt gratitude to Sabir Hussain, Alok Sharma, Kamal Rana, Pravesh Bhardwaj and Sukhveer Cheema for their invaluable assistance and support during the fieldwork phase of this research. The authors are grateful to the Principal Chief Conservator of Forests (PCCF) of the Haryana Forest Department and the Himachal Pradesh Forest Department for kindly permitting them to visit the selected protected areas. Additionally, we appreciate the Forest Department of Himachal Pradesh staff and authorities, who facilitated the logistics and permits required for the fieldwork. We also appreciate the members of eFlora of India (eFI), Global Biodiversity Information Facility (GBIF), India Biodiversity Portal (IBP), iNaturalist, and other social media groups for their invaluable contributions towards the identification and documentation of biodiversity from the study area.

# Author Contributions {.unnumbered}

```{r eval=TRUE}
auth.cont <- function(author){
  df_auth <- read.csv("credit_author.csv") |>
    select(Contribution, all_of(author)) |>
    drop_na()
  
  paste0(df_auth[, 1], " (", df_auth[, 2], ")", collapse = ", ")
}
```

**Abhishek Kumar:** `r auth.cont("AK")`. **Meenu Patil:** `r auth.cont("MP")`. **Pardeep Kumar:** `r auth.cont("PK")`. **Anand Narain Singh:** `r auth.cont("ANS")`.

# Conflict of Interest Statement {.unnumbered}

The authors declare no conflicts of interest.

# Funding {.unnumbered}

University Grants Commission, Government of India, New Delhi is acknowledged for financial support in the form of Senior Research Fellowships to *Abhishek Kumar* [507/ (OBC) (CSIR-UGC NET DEC. 2016)], *Meenu Patil* [492/ (CSIR-UGC NET JUNE 2017)], and *Pardeep Kumar* [443/ (CSIR-UGC NET DEC. 2017)].

# ORCID  {.unnumbered}
Abhishek Kumar (<https://orcid.org/0000-0003-2252-7623>); Meenu Patil (<https://orcid.org/0000-0002-7664-7877>); Pardeep Kumar (<https://orcid.org/0000-0001-6707-1485>); Anand Narain Singh (<https://orcid.org/0000-0002-0148-8680>) 

\newpage
# References {.unnumbered}
